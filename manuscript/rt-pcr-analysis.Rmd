---
title: "Probability of covid-19 infection given RT-PCR negative"
author: "Stephen A Lauer"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
knitr::opts_knit$set(root.dir = here::here())

options(mc.cores=4,
        scipen=999)
```

```{r library}
library(tidyverse)
library(rstan)
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
n_iter <- 1e4
n_warmup <- 1e4-5e3
p_adapt_delta <- 0.99
n_max_treedepth <- 20
T_max <- 21

source("R/utils.R")

pcr_dat <- read_csv("data/antibody-test-data.csv") %>% 
    mutate(n=n+nqp,
           test_pos=test_pos+nqp) %>% 
    filter(grepl("RT_PCR", test),
           !grepl("Danis", study),
           n > 0,
           # study != "Danis_no_4",
           day >= 0) %>% 
    mutate(study_idx=paste(study, test, sep="_") %>% as.factor() %>% as.numeric(),
           pct_pos=test_pos/n)

naso_dat <- pcr_dat %>% 
    filter(grepl("RT_PCR_naso", test)) %>% 
    mutate(study_idx=paste(study, test, sep="_") %>% as.factor()
           %>% as.numeric(),
           pct_pos=test_pos/n)

oro_dat <- pcr_dat %>% 
    filter(grepl("RT_PCR_oro", test)) %>% 
    mutate(study_idx=paste(study, test, sep="_") %>% as.factor()
           %>% as.numeric(),
           pct_pos=test_pos/n)

kuj_dat <- read_csv("data/antibody-test-data.csv") %>% 
    mutate(n = n+inconclusive) %>% 
    filter(grepl("RT_PCR", test), n > 0) %>% 
    mutate(study_idx=paste(study, test, sep="_") %>% as.factor()
           %>% as.numeric(),
           pct_pos=test_pos/n)
```

In this paper, we will try to determine the probability that someone has covid-19 given a negative RT-PCR test.

## Methods

[Zhao et al. (2020)](https://academic.oup.com/cid/advance-article/doi/10.1093/cid/ciaa344/5812996), [Liu et al. (2020)](https://www.medrxiv.org/content/10.1101/2020.03.06.20031856v1), [Guo et al. (2020)](https://academic.oup.com/cid/article-abstract/doi/10.1093/cid/ciaa310/5810754), and [WÃ¶lfel et al. (2020)](https://www.nature.com/articles/s41586-020-2196-x) looked at the sensitivity of the RT-PCR by time since symptom onset.

```{r raw-figures}
ggplot(data=pcr_dat, aes(x=day, y=pct_pos, size=n, color=study)) +
    facet_grid(.~test) +
    geom_point(alpha=0.4) +
    scale_x_continuous("Days since symptom onset",
                       breaks=seq(0,35,7)) +
    scale_y_continuous("Sensitivity of the RT-PCR test") +
    scale_size_continuous("Number of\nobservations") +
    scale_color_manual("Study",
                       values=cbbPalette[-1]) +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    theme_bw()
```

The sensitivity rises to a peak 4 days after symptom onset then declines for the next couple of weeks.

If we know the risk of an individual, we can find the negative predictive value -- the probability that someone who tests negative is actually negative.
From [Bi et al.](https://www.medrxiv.org/content/10.1101/2020.03.03.20028423v3), we know that about 15% (77/517) household contacts later tested positive for covid-19.

We use logistic regression for the sensitivity of the RT-PCR with a cubic polynomial for the log of time since exposure and use that, along with the probability of infection given exposure, to estimate the negative predictive value of the RT-PCR.
We use estimates of the incubation period from [Lauer, Grantz, et al. (2020)](https://annals.org/aim/fullarticle/2762808/incubation-period-coronavirus-disease-2019-covid-19-from-publicly-reported).
From this, we can find the probability of having a covid-19 infection despite being RT-PCR negative.

We use Stan for this analysis.

## Results

```{r npv-fixed-onset, cache=T, eval=T, include=F}
## fit a model to find the overall seroincidence across all observations
npv_onset_model <- stan_model("Stan/npv-fixed-onset.stan")

main_analysis <- make_analysis_data(stan_model=npv_onset_model,
                                    data_list=list(N=nrow(pcr_dat),
                                                   J=max(pcr_dat$study_idx),
                                                   T_max=T_max,
                                                   test_n=pcr_dat$n,
                                                   test_pos=pcr_dat$test_pos,
                                                   study_idx=pcr_dat$study_idx,
                                                   t_symp_test=pcr_dat$day,
                                                   exposed_n=686,
                                                   exposed_pos=77,
                                                   t_exp_symp=5,
                                                   spec=1),
                                    iter=n_iter,
                                    warmup=n_warmup,
                                    control=list(adapt_delta=p_adapt_delta,
                                                 max_treedepth=n_max_treedepth),
                                    save_warmup=F,
                                    save_stan=F)
```

```{r main-figure}
fnr_fig <- ggplot(data=main_analysis$plot_dat, aes(x=days_since_exposure)) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_errorbar(aes(ymin=fnr_lb, ymax=fnr_ub), color="gray30") +
    geom_point(aes(y=fnr_med)) +
    scale_x_continuous("",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability RT-PCR negative,\ngiven covid-19 positive",
                       limits=c(0,1)) +
    theme_bw() +
    theme(axis.text.y=element_text(color="black"),
          axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks=element_blank())

for_fig <- ggplot(data=main_analysis$plot_dat, aes(x=days_since_exposure)) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_errorbar(aes(ymax=for_lb, ymin=for_ub), color="gray30") +
    geom_point(aes(y=for_med)) +
    scale_x_continuous("Days since exposure",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative",
                       limits=c(0, 0.15),
                       breaks=seq(0,0.15, 0.05)) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))

gridExtra::grid.arrange(fnr_fig, for_fig)

# ggplot(plot_dat, aes(x=days_since_exposure)) +
#     geom_hline(aes(yintercept=1), linetype="dashed") +
#     geom_errorbar(aes(ymax=1-rr_lb, ymin=1-rr_ub), color="gray30") +
#     geom_point(aes(y=1-rr_med)) +
#     scale_x_continuous("Days since exposure",
#                        breaks=seq(0, 21, 7),
#                        limits=c(0,21.5)) +
#     scale_y_log10("Relative risk of having a negative RT-PCR test",
#                   breaks=2^c(-3:1),
#                   labels=c("1/8", "1/4", "1/2", "1", "2")) +
#     coord_cartesian(ylim=c(2^-3, 2^1)) +
#     theme_bw() +
#     theme(axis.text=element_text(color="black"))
```


With no data on RT-PCR to time prior to symptom onset, the estimates of sensitivity at or below day five are low with large credible intervals.
Due to the decline in sensitivity over time, the RT-PCR test is best deployed about a week after exposure.
A day or two after exposure (3 or 4 days prior to symptoms), the test may have no utility at all, and thus the probability of having been infected is would be the same with or without an RT-PCR, in our case about 11%.
Seven to nine days after exposure (roughly 2 to 4 days after symptom onset), the negative predictive value is around 95%, meaning there is about a 5% chance of actually being covid-19 positive despite testing negative.

```{r sub-est, cache=T, eval=F}
naso_est <- make_analysis_data(stan_model=npv_onset_model,
                               data_list=list(N=nrow(naso_dat),
                                              J=max(naso_dat$study_idx),
                                              T_max=T_max,
                                              test_n=naso_dat$n,
                                              test_pos=naso_dat$test_pos,
                                              study_idx=naso_dat$study_idx,
                                              t_symp_test=naso_dat$day,
                                              exposed_n=686,
                                              exposed_pos=77,
                                              t_exp_symp=5,
                                              spec=1),
                               iter=n_iter,
                               warmup=n_warmup,
                               control=list(adapt_delta=p_adapt_delta,
                                            max_treedepth=n_max_treedepth),
                               save_warmup=F)

oro_est <- make_analysis_data(stan_model=npv_onset_model,
                              data_list=list(N=nrow(oro_dat),
                                             J=max(oro_dat$study_idx),
                                             T_max=T_max,
                                             test_n=oro_dat$n,
                                             test_pos=oro_dat$test_pos,
                                             study_idx=oro_dat$study_idx,
                                             t_symp_test=oro_dat$day,
                                             exposed_n=686,
                                             exposed_pos=77,
                                             t_exp_symp=5,
                                             spec=1),
                              iter=n_iter,
                              warmup=n_warmup,
                              control=list(adapt_delta=p_adapt_delta,
                                           max_treedepth=n_max_treedepth),
                              save_warmup=F)
```

```{r plot-sub, eval=F}
bind_rows(naso_est$plot_dat %>% mutate(test="naso"),
          # oro_est$plot_dat %>% mutate(test="oro"),
          main_analysis$plot_dat %>% mutate(test="original")) %>% 
    ggplot(aes(x=days_since_exposure, fill=as.factor(test),
               color=as.factor(test))) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_ribbon(aes(ymin=for_lb, ymax=for_ub), alpha=0.5) +
    geom_line(aes(y=for_med)) +
    scale_x_continuous("",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative",
                       limits=c(0,0.15)) +
    scale_color_manual("Subset",
                       values=cbbPalette[c(2,1)]) +
    scale_fill_manual("Subset",
                      values=cbbPalette[c(2,1)]) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))
```

## Sensitivity analyses

### Specificity

What if the specificity of the test is less than 100%?
To test this we fit the same model except with a specificity of 90% and compared the results to the original (the sensitivity remained the same).

```{r sens-analysis-spec, cache=T, eval=T}
spec_est <- make_analysis_data(stan_model=npv_onset_model,
                                    data_list=list(N=nrow(pcr_dat),
                                                   J=max(pcr_dat$study_idx),
                                                   T_max=T_max,
                                                   test_n=pcr_dat$n,
                                                   test_pos=pcr_dat$test_pos,
                                                   study_idx=pcr_dat$study_idx,
                                                   t_symp_test=pcr_dat$day,
                                                   exposed_n=686,
                                                   exposed_pos=77,
                                                   t_exp_symp=5,
                                                   spec=0.9),
                                    iter=n_iter,
                                    warmup=n_warmup,
                                    control=list(adapt_delta=p_adapt_delta,
                                                 max_treedepth=n_max_treedepth),
                                    save_warmup=F)
```

```{r plot-spec}
spec_est$plot_dat %>% 
    mutate(spec="90%") %>% 
    bind_rows(main_analysis$plot_dat %>% mutate(spec="100%")) %>% 
    ggplot(aes(x=days_since_exposure, color=spec, fill=spec)) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_ribbon(aes(ymax=for_lb, ymin=for_ub), alpha=0.5) +
    # geom_errorbar(aes(ymax=for_lb, ymin=for_ub), alpha=0.5) +
    geom_line(aes(y=for_med)) +
    # geom_point(aes(y=for_med)) +
    scale_x_continuous("Days since exposure",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative",
                       limits=c(0, 0.16),
                       breaks=seq(0,0.15, 0.05)) +
    scale_color_manual("Specificity",
                       values=cbbPalette) +
    scale_fill_manual("Specificity",
                      values=cbbPalette) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))
```

The shape of the curve for 90% specificity is similar to that of 100%, though slightly elevated.
The best time to test is still 2-4 days post-symptom onset.

\pagebreak

### Different attack rates

We tested attack rates of half, twice, and four times that of Bi et al. (2020).

```{r ar-est, cache=T, eval=T}
half_est <- make_analysis_data(stan_model=npv_onset_model,
                                    data_list=list(N=nrow(pcr_dat),
                                                   J=max(pcr_dat$study_idx),
                                                   T_max=T_max,
                                                   test_n=pcr_dat$n,
                                                   test_pos=pcr_dat$test_pos,
                                                   study_idx=pcr_dat$study_idx,
                                                   t_symp_test=pcr_dat$day,
                                                   exposed_n=686,
                                                   exposed_pos=round(77/2),
                                                   t_exp_symp=5,
                                                   spec=1),
                                    iter=n_iter,
                                    warmup=n_warmup,
                                    control=list(adapt_delta=p_adapt_delta,
                                                 max_treedepth=n_max_treedepth),
                                    save_warmup=F)

two_est <- make_analysis_data(stan_model=npv_onset_model,
                              data_list=list(N=nrow(pcr_dat),
                                             J=max(pcr_dat$study_idx),
                                             T_max=T_max,
                                             test_n=pcr_dat$n,
                                             test_pos=pcr_dat$test_pos,
                                             study_idx=pcr_dat$study_idx,
                                             t_symp_test=pcr_dat$day,
                                             exposed_n=686,
                                             exposed_pos=2*77,
                                             t_exp_symp=5,
                                             spec=1),
                              iter=n_iter,
                              warmup=n_warmup,
                              control=list(adapt_delta=p_adapt_delta,
                                           max_treedepth=n_max_treedepth),
                              save_warmup=F)

four_est <- make_analysis_data(stan_model=npv_onset_model,
                               data_list=list(N=nrow(pcr_dat),
                                              J=max(pcr_dat$study_idx),
                                              T_max=T_max,
                                              test_n=pcr_dat$n,
                                              test_pos=pcr_dat$test_pos,
                                              study_idx=pcr_dat$study_idx,
                                              t_symp_test=pcr_dat$day,
                                              exposed_n=686,
                                              exposed_pos=4*77,
                                              t_exp_symp=5,
                                              spec=1),
                               iter=n_iter,
                               warmup=n_warmup,
                               control=list(adapt_delta=p_adapt_delta,
                                            max_treedepth=n_max_treedepth),
                               save_warmup=F)
```

```{r plot-ar}
bind_rows(half_est$plot_dat %>% mutate(ar_idx="half"),
          two_est$plot_dat %>% mutate(ar_idx="2x"),
          four_est$plot_dat %>% mutate(ar_idx="4x"),
          main_analysis$plot_dat %>% mutate(ar_idx="Bi")) %>% 
    ggplot(aes(x=days_since_exposure, fill=as.factor(ar_idx),
               color=as.factor(ar_idx))) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    # geom_ribbon(aes(ymin=for_lb, ymax=for_ub), alpha=0.3) +
    geom_line(aes(y=for_med)) +
    scale_x_continuous("",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative") +
    scale_color_manual("Attack rate",
                       values=cbbPalette[c(2,3,1,4)],
                       breaks=c("half", "Bi", "2x", "4x"),
                       labels=c("5.5%", "11%", "22%", "44%")) +
    scale_fill_manual("Attack rate",
                       values=cbbPalette[c(2,3,1,4)],
                       breaks=c("half", "Bi", "2x", "4x"),
                       labels=c("5.5%", "11%", "22%", "44%")) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))
```

As the attack rate increases, the shape looks more like the false negative rate seen above in Figure 2.
As the attack rate decreases, the probabilities approach 0 and thus the entire curve flattens out.
Regardless, the best time to test is still 2-4 days after symptom onset.

\pagebreak

### Different incubation period lengths

We originally assumed a 5-day incubation period, what if that was 3 or 7 days instead?

```{r inc-est, cache=T, eval=T}
three_day_est <- make_analysis_data(stan_model=npv_onset_model,
                                    data_list=list(N=nrow(pcr_dat),
                                                   J=max(pcr_dat$study_idx),
                                                   T_max=T_max,
                                                   test_n=pcr_dat$n,
                                                   test_pos=pcr_dat$test_pos,
                                                   study_idx=pcr_dat$study_idx,
                                                   t_symp_test=pcr_dat$day,
                                                   exposed_n=686,
                                                   exposed_pos=77,
                                                   t_exp_symp=3,
                                                   spec=1),
                                    iter=n_iter,
                                    warmup=n_warmup,
                                    control=list(adapt_delta=p_adapt_delta,
                                                 max_treedepth=n_max_treedepth),
                                    save_warmup=F)

seven_day_est <- make_analysis_data(stan_model=npv_onset_model,
                               data_list=list(N=nrow(pcr_dat),
                                              J=max(pcr_dat$study_idx),
                                              T_max=T_max,
                                              test_n=pcr_dat$n,
                                              test_pos=pcr_dat$test_pos,
                                              study_idx=pcr_dat$study_idx,
                                              t_symp_test=pcr_dat$day,
                                              exposed_n=686,
                                              exposed_pos=77,
                                              t_exp_symp=7,
                                              spec=1),
                               iter=n_iter,
                               warmup=n_warmup,
                               control=list(adapt_delta=p_adapt_delta,
                                            max_treedepth=n_max_treedepth),
                               save_warmup=F)
```

```{r plot-inc}
bind_rows(three_day_est$plot_dat %>% mutate(inc_period="3d"),
          seven_day_est$plot_dat %>% mutate(inc_period="7d"),
          main_analysis$plot_dat %>% mutate(inc_period="5d")) %>% 
    ggplot(aes(x=days_since_exposure, fill=as.factor(inc_period),
               color=as.factor(inc_period))) +
    geom_vline(aes(xintercept=3), linetype="dashed", color=cbbPalette[2]) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_vline(aes(xintercept=7), linetype="dashed", color=cbbPalette[3]) +
    # geom_ribbon(aes(ymin=for_lb, ymax=for_ub), alpha=0.1) +
    geom_line(aes(y=for_med)) +
    scale_x_continuous("",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative",
                       limits=c(0,0.15)) +
    scale_color_manual("Incubation period",
                       values=cbbPalette[c(2,1,3)]) +
    scale_fill_manual("Incubation period",
                      values=cbbPalette[c(2,1,3)]) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))
```

Changing the length of the incubation period changes the progression of the false omission rate (probability infected given test negative).
Since the sensitivity is calibrated with respect to the time of symptom onset, an earlier onset time leads to a quicker drop in false omission rate and a later onset time leads to a slower drop.

<!-- \pagebreak -->

<!-- ### Shift Guo days one day earlier -->

<!-- The timing of the days since symptom onset are ambiguous in Guo et al., where day 1 may mean one day since symptom onset or the first day of symptoms. -->

```{r guo-est, cache=T, eval=F}
guo_est <- make_analysis_data(stan_model=npv_onset_model,
                                    data_list=list(N=nrow(pcr_dat),
                                                   J=max(pcr_dat$study_idx),
                                                   T_max=T_max,
                                                   test_n=pcr_dat$n,
                                                   test_pos=pcr_dat$test_pos,
                                                   study_idx=pcr_dat$study_idx,
                                                   t_symp_test=pcr_dat$day_min,
                                                   exposed_n=686,
                                                   exposed_pos=77,
                                                   t_exp_symp=5,
                                                   spec=1),
                                    iter=n_iter,
                                    warmup=n_warmup,
                                    control=list(adapt_delta=p_adapt_delta,
                                                 max_treedepth=n_max_treedepth),
                                    save_warmup=F)
```

```{r plot-guo, eval=F}
bind_rows(guo_est$plot_dat %>% mutate(guo_day="0d"),
          main_analysis$plot_dat %>% mutate(guo_day="1d")) %>% 
    ggplot(aes(x=days_since_exposure, fill=as.factor(guo_day),
               color=as.factor(guo_day))) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_ribbon(aes(ymin=for_lb, ymax=for_ub), alpha=0.5) +
    geom_line(aes(y=for_med)) +
    scale_x_continuous("",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative",
                       limits=c(0,0.15)) +
    scale_color_manual("Guo first day",
                       values=cbbPalette[c(2,1)]) +
    scale_fill_manual("Guo first day",
                      values=cbbPalette[c(2,1)]) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))
```

<!-- Shifting the Guo et al. timing one day earlier improves the median sensitivity of the early tests, such that the best days for testing would shift from 1-3 days post-symptom onset to 0-2 days post-sypmtom onset. -->
<!-- The log-likelihoods for each model are nearly identical with the main analysis being minutely better. -->
<!-- The overlap in credible intervals indicates that the estimates are roughly equivalent. -->

<!-- \pagebreak -->

<!-- ### Kujawski inconclusive tests as negatives -->

<!-- Kujawski et al. reported 23 inconclusive tests in their nasopharyngeal (14) and oropharyngeal (9) swabs. -->
<!-- In our main analysis, we omit these swabs, but they could count as negative tests instead. -->

```{r kuj-est, cache=T, eval=F}
kuj_est <- make_analysis_data(stan_model=npv_onset_model,
                                    data_list=list(N=nrow(kuj_dat),
                                                   J=max(kuj_dat$study_idx),
                                                   T_max=T_max,
                                                   test_n=kuj_dat$n,
                                                   test_pos=kuj_dat$test_pos,
                                                   study_idx=kuj_dat$study_idx,
                                                   t_symp_test=kuj_dat$day,
                                                   exposed_n=686,
                                                   exposed_pos=77,
                                                   t_exp_symp=5,
                                                   spec=1),
                                    iter=n_iter,
                                    warmup=n_warmup,
                                    control=list(adapt_delta=p_adapt_delta,
                                                 max_treedepth=n_max_treedepth),
                                    save_warmup=F)
```

```{r plot-kuj, eval=F}
bind_rows(kuj_est$plot_dat %>% mutate(kuj="negatives"),
          main_analysis$plot_dat %>% mutate(kuj="omitted")) %>% 
    ggplot(aes(x=days_since_exposure, fill=as.factor(kuj),
               color=as.factor(kuj))) +
    geom_vline(aes(xintercept=5), linetype="dashed") +
    geom_ribbon(aes(ymin=for_lb, ymax=for_ub), alpha=0.5) +
    geom_line(aes(y=for_med)) +
    scale_x_continuous("",
                       breaks=seq(0, 21, 7),
                       limits=c(0,21.5)) +
    scale_y_continuous("Probability infected,\ngiven RT-PCR negative",
                       limits=c(0,0.15)) +
    scale_color_manual("Inconclusives as",
                       values=cbbPalette[c(2,1)]) +
    scale_fill_manual("Inconclusives as",
                      values=cbbPalette[c(2,1)]) +
    theme_bw() +
    theme(axis.text=element_text(color="black"))
```

<!-- Using the inconclusive results as negatives, makes the model slightly worse after the first week. -->
